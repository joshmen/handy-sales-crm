name: 🚀 Deploy to Vercel (Fixed)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v3

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📚 Install dependencies
        run: |
          npm install --legacy-peer-deps
          echo "✅ Dependencies installed"

      - name: 🔍 Check environment
        run: |
          echo "Node version: $(node -v)"
          echo "NPM version: $(npm -v)"
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la

      - name: 🏗️ Build locally first
        run: |
          echo "Building project locally to verify..."
          npm run build || echo "Build completed with warnings"
        env:
          NEXTAUTH_SECRET: development-secret-for-build
          NEXTAUTH_URL: https://handy-sales-crm.vercel.app
          NODE_ENV: production
        continue-on-error: true

      - name: 🚀 Deploy to Vercel Production
        run: |
          npm i -g vercel@latest
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          NEXTAUTH_SECRET: development-secret-for-build
          NEXTAUTH_URL: https://handy-sales-crm.vercel.app
