name: Deploy APIs to Railway

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - 'apps/billing/**'
      - 'apps/mobile/**'
      - 'libs/**'
      - 'infra/docker/Dockerfile.*.Prod'
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Deploy all services'
        required: false
        default: 'true'

# Required secrets (configure in GitHub repo settings):
# - PRODUCTION_DB_CONNECTION_STRING: MySQL connection string for EF Core migrations
#
# Railway auto-deploys from main branch (configured in Railway dashboard).
# This workflow only runs EF Core migrations BEFORE Railway deploys.
# Enable "Wait for CI" in Railway service settings so it waits for migrations.

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      main-api: ${{ steps.filter.outputs.main-api }}
      billing-api: ${{ steps.filter.outputs.billing-api }}
      mobile-api: ${{ steps.filter.outputs.mobile-api }}
      deploy-all: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            main-api:
              - 'apps/api/**'
              - 'libs/**'
              - 'infra/docker/Dockerfile.Main.Prod'
            billing-api:
              - 'apps/billing/**'
              - 'infra/docker/Dockerfile.Billing.Prod'
            mobile-api:
              - 'apps/mobile/**'
              - 'libs/**'
              - 'infra/docker/Dockerfile.Mobile.Prod'

  migrate-database:
    name: Apply Database Migrations
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.main-api == 'true' ||
      needs.detect-changes.outputs.mobile-api == 'true' ||
      needs.detect-changes.outputs.deploy-all == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef --version 8.0.11

      - name: Build efbundle
        run: |
          dotnet ef migrations bundle \
            --project libs/HandySales.Infrastructure \
            --startup-project apps/api/src/HandySales.Api \
            --output ./efbundle \
            --force

      - name: Apply migrations to production
        env:
          ConnectionStrings__DefaultConnection: ${{ secrets.PRODUCTION_DB_CONNECTION_STRING }}
        run: |
          chmod +x ./efbundle
          ./efbundle --connection "$ConnectionStrings__DefaultConnection" --verbose

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, migrate-database]
    if: always()
    steps:
      - name: Print deployment results
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Database Migrations | ${{ needs.migrate-database.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Railway auto-deploys from main branch after CI passes." >> $GITHUB_STEP_SUMMARY
